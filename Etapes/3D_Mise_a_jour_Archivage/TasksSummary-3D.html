<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©capitulatif des T√¢ches - To-Do List</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(145deg, #e7f7e7 0%, #d5e9d5 40%, #b8d4b8 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            color: #2d5016;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #4a7c59;
            border-radius: 6px;
            background-color: white;
            color: #4a7c59;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .filter-btn:hover {
            background-color: #4a7c59;
            color: white;
        }

        .filter-btn.active {
            background-color: #2d5016;
            color: white;
            border-color: #2d5016;
        }

        .btn {
            padding: 12px 24px;
            background-color: #2d5016;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 700;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .btn:hover {
            background-color: #1f360e;
            transform: translateY(-2px);
        }

        .task-count {
            font-size: 1.1em;
            color: #4a7c59;
            font-weight: 700;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        thead {
            background-color: #2d5016;
            color: white;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 700;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s ease;
        }

        tbody tr:hover {
            background-color: #f9fff9;
        }

        td {
            padding: 12px 10px;
            font-size: 0.95em;
        }

        /* Badges de priorit√© */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
            text-align: center;
        }

        .priority-1, .priority-2 {
            background-color: #e74c3c;
            color: white;
        }

        .priority-3 {
            background-color: #f39c12;
            color: white;
        }

        .priority-4, .priority-5 {
            background-color: #95a5a6;
            color: white;
        }

        /* Badges de progression */
        .status-1 {
            background-color: #3498db;
            color: white;
        }

        .status-2, .status-3 {
            background-color: #f39c12;
            color: white;
        }

        .status-4 {
            background-color: #e74c3c;
            color: white;
        }

        .status-5 {
            background-color: #9b59b6;
            color: white;
        }

        .status-6 {
            background-color: #27ae60;
            color: white;
        }

        .status-7 {
            background-color: #95a5a6;
            color: white;
        }

        /* Boutons d'actions */
        .status-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
        }

        .status-btn {
            padding: 6px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: white;
            color: #666;
        }

        .status-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .status-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Boutons de statut actifs */
        .status-btn.active-1 {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .status-btn.active-2,
        .status-btn.active-3 {
            background-color: #f39c12;
            color: white;
            border-color: #f39c12;
        }

        .status-btn.active-4 {
            background-color: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        .status-btn.active-5 {
            background-color: #9b59b6;
            color: white;
            border-color: #9b59b6;
        }

        .status-btn.active-6 {
            background-color: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        .status-btn.active-7 {
            background-color: #95a5a6;
            color: white;
            border-color: #95a5a6;
        }

        .no-tasks {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .no-tasks-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .no-tasks h2 {
            font-family: 'Playfair Display', serif;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .no-tasks p {
            margin-bottom: 20px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            table {
                font-size: 0.85em;
            }
            
            th, td {
                padding: 10px 5px;
            }
            
            .badge {
                font-size: 0.75em;
                padding: 3px 8px;
            }
            
            .status-btn {
                padding: 5px 10px;
                font-size: 0.7em;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }
            
            .header-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-buttons {
                justify-content: center;
                margin: 10px 0;
            }
            
            .btn {
                width: 100%;
                text-align: center;
            }

            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            th, td {
                font-size: 0.85em;
            }
            
            .status-buttons {
                gap: 3px;
            }
            
            .status-btn {
                padding: 4px 8px;
                font-size: 0.65em;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .filter-btn {
                font-size: 0.85em;
                padding: 6px 12px;
            }
            
            .task-count {
                font-size: 0.95em;
            }
            
            table {
                font-size: 0.8em;
            }
            
            .status-btn {
                padding: 3px 6px;
                font-size: 0.6em;
                min-width: 24px;
            }
        }
    </style>

    <script>
        // A) Variables globales pour les donn√©es de r√©f√©rence
        // Port√©e globale : ces variables sont accessibles depuis n'importe quelle fonction
        let priorityList = [];
        let taskProgressionList = [];
        let academicSubjectsList = [];
        let currentFilter = 'all'; // Filtre actuel : 'all', '6' (termin√©es), '7' (archiv√©es)
        
        // B) Lecture des t√¢ches depuis localStorage
        let tasksList = [];
        
        console.log("üöÄ Chargement de la page de r√©capitulatif des t√¢ches");
        
        // Lecture du localStorage
        let storedTasks = localStorage.getItem("tasksData");
        
        if (storedTasks) {
            console.log("‚úÖ Des t√¢ches ont √©t√© trouv√©es dans le localStorage");
            tasksList = JSON.parse(storedTasks);
            console.log("üìä Nombre de t√¢ches r√©cup√©r√©es :", tasksList.length);
            console.log("üìã Liste des t√¢ches :", tasksList);
        } else {
            console.log("‚ÑπÔ∏è Aucune t√¢che trouv√©e dans le localStorage");
        }
        
        // C) Attendre que le document soit enti√®rement charg√©
        document.onreadystatechange = function() {
            console.log("üìÑ √âtat du document :", document.readyState);
            
            if (document.readyState === "complete") {
                console.log("‚úÖ Document enti√®rement charg√©");
                
                // Charger les donn√©es de r√©f√©rence (priorit√©s, statuts, etc.)
                loadReferenceData();
            }
        };
        
        /**
         * Charge les donn√©es de r√©f√©rence depuis les fichiers JSON
         */
        async function loadReferenceData() {
            console.log("üì• Chargement des donn√©es de r√©f√©rence...");
            
            try {
                // Charger les donn√©es de priorit√©
                const priorityResponse = await fetch('../Data/priorityStatus.json');
                const priorityData = await priorityResponse.json();
                priorityList = priorityData.priorityStatus;
                console.log("‚úÖ Priorit√©s charg√©es :", priorityList);
                
                // Charger les donn√©es de progression
                const progressResponse = await fetch('../Data/taskProgression.json');
                const progressData = await progressResponse.json();
                taskProgressionList = progressData.taskProgression;
                console.log("‚úÖ Statuts de progression charg√©s :", taskProgressionList);
                
                // Charger les sujets acad√©miques
                const subjectsResponse = await fetch('../Data/academic_subjects.json');
                const subjectsData = await subjectsResponse.json();
                academicSubjectsList = subjectsData.academicConfiguration.subjects;
                console.log("‚úÖ Sujets acad√©miques charg√©s :", academicSubjectsList);
                
                // Maintenant que tout est charg√©, g√©n√©rer le tableau
                generateTasksTable();
                
            } catch (error) {
                console.error("‚ùå Erreur lors du chargement des donn√©es de r√©f√©rence :", error);
            }
        }
        
        /**
         * D) G√©n√®re et ins√®re le tableau HTML des t√¢ches
         * @param {string} filter - Filtre √† appliquer : 'all', '6', '7'
         */
        function generateTasksTable(filter = 'all') {
            console.log(`üèóÔ∏è G√©n√©ration du tableau HTML des t√¢ches (filtre: ${filter})`);
            
            const tbody = document.getElementById('tasksTableBody');
            const taskCount = document.getElementById('taskCount');
            
            // Filtrer les t√¢ches selon le filtre s√©lectionn√©
            let filteredTasks;
            if (filter === 'all') {
                // Toutes les t√¢ches sauf les archiv√©es
                filteredTasks = tasksList.filter(task => task.idTaskProgression != "7");
            } else if (filter === '6') {
                // Seulement les t√¢ches termin√©es
                filteredTasks = tasksList.filter(task => task.idTaskProgression == "6");
            } else if (filter === '7') {
                // Seulement les t√¢ches archiv√©es
                filteredTasks = tasksList.filter(task => task.idTaskProgression == "7");
            } else {
                filteredTasks = tasksList;
            }
            
            // Afficher le nombre de t√¢ches
            const filterLabel = filter === 'all' ? 'active(s)' : 
                               filter === '6' ? 'termin√©e(s)' : 
                               filter === '7' ? 'archiv√©e(s)' : '';
            taskCount.textContent = `${filteredTasks.length} t√¢che(s) ${filterLabel} / ${tasksList.length} total`;
            
            // Vider le tbody avant de le remplir
            tbody.innerHTML = '';
            
            // Si aucune t√¢che, afficher un message
            if (filteredTasks.length === 0) {
                const message = filter === 'all' ? 'Aucune t√¢che active' :
                               filter === '6' ? 'Aucune t√¢che termin√©e' :
                               filter === '7' ? 'Aucune t√¢che archiv√©e' : 'Aucune t√¢che';
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-tasks">
                            <div class="no-tasks-icon">üìã</div>
                            <h2>${message}</h2>
                            <p>${filter === 'all' ? 'Commencez par cr√©er votre premi√®re t√¢che !' : 'Changez de filtre pour voir d\'autres t√¢ches.'}</p>
                            ${filter === 'all' ? '<a href="Form-ToDoList.html" class="btn">Cr√©er une t√¢che</a>' : ''}
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Variable pour construire le HTML
            let htmlContent = '';
            
            // Parcourir toutes les t√¢ches filtr√©es avec forEach()
            filteredTasks.forEach((task, index) => {
                console.log(`üìå Traitement de la t√¢che ${index + 1} :`, task);
                
                // Rechercher la priorit√© correspondante avec find()
                // La fonction fl√©ch√©e compare l'idPriorite de chaque √©l√©ment avec celui de la t√¢che
                const priorityObj = priorityList.find(
                    element => element.idPriorite == task.idPriorite
                );
                const priorityLabel = priorityObj ? priorityObj.priorite : 'Non d√©fini';
                console.log(`  üîç Priorit√© trouv√©e : ${priorityLabel}`);
                
                // Rechercher le statut de progression
                const progressObj = taskProgressionList.find(
                    element => element.idTaskProgression == task.idTaskProgression
                );
                const progressLabel = progressObj ? progressObj.taskProgressionStatus : 'Non d√©fini';
                console.log(`  üîç Statut trouv√© : ${progressLabel}`);
                
                // Rechercher le sujet acad√©mique
                const subjectObj = academicSubjectsList.find(
                    element => element.idAcademicSubject == task.idAcademicSubject
                );
                const subjectLabel = subjectObj ? subjectObj.academicSubjectName : 'Non d√©fini';
                console.log(`  üîç Sujet trouv√© : ${subjectLabel}`);
                
                // Formater la date de cr√©ation
                const dateCreation = new Date(task.date_de_creation);
                const dateFormatted = dateCreation.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // G√©n√©rer les boutons de statut
                let statusButtons = '';
                taskProgressionList.forEach(status => {
                    const isActive = status.idTaskProgression == task.idTaskProgression;
                    const activeClass = isActive ? `active-${status.idTaskProgression}` : '';
                    const disabled = isActive ? 'disabled' : '';
                    
                    statusButtons += `
                        <button 
                            class="status-btn ${activeClass}" 
                            data-task-id="${task.id}" 
                            data-status-id="${status.idTaskProgression}"
                            onclick="updateTaskStatus(${task.id}, '${status.idTaskProgression}')"
                            ${disabled}
                            title="${status.taskProgressionStatus}">
                            ${status.idTaskProgression}
                        </button>
                    `;
                });
                
                // Construire la ligne HTML avec template literals (backticks)
                // L'interpolation ${...} permet d'ins√©rer des variables dynamiquement
                htmlContent += `
                    <tr data-task-id="${task.id}">
                        <td>${task.id}</td>
                        <td><strong>${task.libelle}</strong></td>
                        <td>${task.assignation}</td>
                        <td>${subjectLabel}</td>
                        <td>
                            <span class="badge priority-${task.idPriorite}">
                                ${priorityLabel}
                            </span>
                        </td>
                        <td>
                            <span class="badge status-${task.idTaskProgression}">
                                ${progressLabel}
                            </span>
                        </td>
                        <td>${dateFormatted}</td>
                        <td>
                            <div class="status-buttons">
                                ${statusButtons}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            console.log("‚úÖ HTML g√©n√©r√© avec succ√®s");
            
            // Ins√©rer le HTML dans le tbody
            // insertAdjacentHTML avec "beforeend" ajoute le contenu √† la fin de l'√©l√©ment
            tbody.insertAdjacentHTML("beforeend", htmlContent);
            
            console.log("‚úÖ Tableau ins√©r√© dans le DOM");
        }
        
        /**
         * √âtape 3D : Mise √† jour du statut d'une t√¢che
         * @param {number} taskId - L'ID de la t√¢che √† mettre √† jour
         * @param {string} newStatusId - Le nouvel ID de statut
         */
        function updateTaskStatus(taskId, newStatusId) {
            console.log(`üîÑ Mise √† jour du statut de la t√¢che ${taskId} vers ${newStatusId}`);
            
            // C) Gestion du changement de statut
            
            // 1. Lire la liste des t√¢ches depuis le localStorage
            let storedTasks = localStorage.getItem("tasksData");
            if (!storedTasks) {
                console.error("‚ùå Aucune t√¢che trouv√©e dans le localStorage");
                return;
            }
            
            tasksList = JSON.parse(storedTasks);
            console.log("üì• T√¢ches recharg√©es depuis localStorage");
            
            // 2. Identifier la t√¢che √† partir de son ID avec find()
            const taskToUpdate = tasksList.find(task => task.id == taskId);
            
            if (!taskToUpdate) {
                console.error(`‚ùå T√¢che ${taskId} non trouv√©e`);
                return;
            }
            
            console.log("üìå T√¢che trouv√©e :", taskToUpdate);
            
            // 3. Mettre √† jour la propri√©t√© statut
            const oldStatus = taskToUpdate.idTaskProgression;
            taskToUpdate.idTaskProgression = newStatusId;
            
            // Mettre √† jour aussi la date de modification
            taskToUpdate.date_de_modification = new Date().toISOString();
            
            // Si le statut passe √† "Termin√©" (6), mettre la date de completion
            if (newStatusId == "6") {
                taskToUpdate.date_de_completion = new Date().toISOString();
                console.log("‚úÖ T√¢che marqu√©e comme termin√©e");
            }
            
            console.log(`‚úèÔ∏è Statut chang√© de ${oldStatus} √† ${newStatusId}`);
            
            // 4. Enregistrer la liste mise √† jour dans le localStorage
            localStorage.setItem("tasksData", JSON.stringify(tasksList));
            console.log("üíæ T√¢ches sauvegard√©es dans localStorage");
            
            // 5. Mettre √† jour l'affichage
            // Si le statut est "Archiv√©" (7), r√©g√©n√©rer tout le tableau
            if (newStatusId == "7") {
                console.log("üì¶ T√¢che archiv√©e - R√©g√©n√©ration du tableau");
                generateTasksTable(currentFilter);
                alert(`‚úÖ T√¢che #${taskId} archiv√©e avec succ√®s !`);
            } else {
                // Sinon, mettre √† jour seulement la ligne concern√©e
                updateTaskRow(taskId);
                
                const statusObj = taskProgressionList.find(s => s.idTaskProgression == newStatusId);
                const statusLabel = statusObj ? statusObj.taskProgressionStatus : newStatusId;
                alert(`‚úÖ Statut de la t√¢che #${taskId} chang√© vers "${statusLabel}"`);
            }
        }
        
        /**
         * Met √† jour uniquement la ligne d'une t√¢che sp√©cifique
         * @param {number} taskId - L'ID de la t√¢che √† mettre √† jour
         */
        function updateTaskRow(taskId) {
            console.log(`üîÑ Mise √† jour de la ligne de la t√¢che ${taskId}`);
            
            // Trouver la t√¢che
            const task = tasksList.find(t => t.id == taskId);
            if (!task) return;
            
            // Trouver la ligne dans le tableau
            const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
            if (!row) return;
            
            // Mettre √† jour le badge de statut
            const statusObj = taskProgressionList.find(s => s.idTaskProgression == task.idTaskProgression);
            const statusLabel = statusObj ? statusObj.taskProgressionStatus : 'Non d√©fini';
            
            const statusCell = row.cells[5]; // Colonne "Statut"
            statusCell.innerHTML = `
                <span class="badge status-${task.idTaskProgression}">
                    ${statusLabel}
                </span>
            `;
            
            // Mettre √† jour les boutons d'action
            const actionsCell = row.cells[7]; // Colonne "Actions"
            let statusButtons = '';
            
            taskProgressionList.forEach(status => {
                const isActive = status.idTaskProgression == task.idTaskProgression;
                const activeClass = isActive ? `active-${status.idTaskProgression}` : '';
                const disabled = isActive ? 'disabled' : '';
                
                statusButtons += `
                    <button 
                        class="status-btn ${activeClass}" 
                        data-task-id="${task.id}" 
                        data-status-id="${status.idTaskProgression}"
                        onclick="updateTaskStatus(${task.id}, '${status.idTaskProgression}')"
                        ${disabled}
                        title="${status.taskProgressionStatus}">
                        ${status.idTaskProgression}
                    </button>
                `;
            });
            
            actionsCell.innerHTML = `<div class="status-buttons">${statusButtons}</div>`;
            
            console.log("‚úÖ Ligne mise √† jour");
        }
        
        /**
         * D) Bonus : Fonction de filtrage des t√¢ches
         * @param {string} filter - Type de filtre : 'all', '6' (termin√©es), '7' (archiv√©es)
         */
        function filterTasks(filter) {
            console.log(`üîç Application du filtre : ${filter}`);
            
            // Mettre √† jour le filtre actuel
            currentFilter = filter;
            
            // Mettre √† jour l'apparence des boutons de filtre
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activer le bouton correspondant
            event.target.classList.add('active');
            
            // R√©g√©n√©rer le tableau avec le filtre
            generateTasksTable(filter);
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>üìã R√©capitulatif des T√¢ches</h1>
        
        <div class="header-actions">
            <div class="task-count" id="taskCount">0 t√¢che(s) enregistr√©e(s)</div>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterTasks('all')">Toutes</button>
                <button class="filter-btn" onclick="filterTasks('6')">Termin√©es</button>
                <button class="filter-btn" onclick="filterTasks('7')">Archiv√©es</button>
            </div>
            <a href="Form-ToDoList.html" class="btn">+ Nouvelle t√¢che</a>
        </div>
        
        <!-- A) Structure de base du tableau HTML -->
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Titre</th>
                    <th>Assign√© √†</th>
                    <th>Sujet</th>
                    <th>Priorit√©</th>
                    <th>Statut</th>
                    <th>Date de cr√©ation</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <!-- Le contenu sera ins√©r√© ici dynamiquement -->
            <tbody id="tasksTableBody">
                <!-- Les lignes seront g√©n√©r√©es par JavaScript -->
            </tbody>
        </table>
    </div>
</body>
</html>
