<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©capitulatif des T√¢ches - To-Do List</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../Style/baseStyle.css">
    <link rel="stylesheet" href="../Style/responsive.css">
    
    <style>
        /* Styles sp√©cifiques √† la page de r√©capitulatif */
        
        .container {
            max-width: 2000px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            box-sizing: border-box;
            min-width: min(100%, 280px);
        }

        h1 {
            font-family: 'Playfair Display', serif;
            color: #2d5016;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #4a7c59;
            border-radius: 6px;
            background-color: white;
            color: #4a7c59;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .filter-btn:hover {
            background-color: #4a7c59;
            color: white;
        }

        .filter-btn.active {
            background-color: #2d5016;
            color: white;
            border-color: #2d5016;
        }

        .btn {
            padding: 12px 24px;
            background-color: #2d5016;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 700;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .btn:hover {
            background-color: #1f360e;
            transform: translateY(-2px);
        }

        .task-count {
            font-size: 1.1em;
            color: #4a7c59;
            font-weight: 700;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        thead {
            background-color: #2d5016;
            color: white;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 700;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s ease;
        }

        tbody tr:hover {
            background-color: #f9fff9;
        }

        td {
            padding: 12px 10px;
            font-size: 0.95em;
        }

        /* Badges de priorit√© */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
            text-align: center;
        }

        .priority-1, .priority-2 {
            background-color: #e74c3c;
            color: white;
        }

        .priority-3 {
            background-color: #f39c12;
            color: white;
        }

        .priority-4, .priority-5 {
            background-color: #95a5a6;
            color: white;
        }

        /* Badges de niveau de comp√©tence */
        .skills-1 {
            background-color: #3498db;
            color: white;
        }

        .skills-2 {
            background-color: #9b59b6;
            color: white;
        }

        .skills-3 {
            background-color: #e67e22;
            color: white;
        }

        .skills-4 {
            background-color: #c0392b;
            color: white;
        }

        /* Badges de difficult√© */
        .difficulty-1 {
            background-color: #2ecc71;
            color: white;
        }

        .difficulty-2 {
            background-color: #1abc9c;
            color: white;
        }

        .difficulty-3 {
            background-color: #f39c12;
            color: white;
        }

        .difficulty-4 {
            background-color: #e74c3c;
            color: white;
        }

        .difficulty-5 {
            background-color: #8e44ad;
            color: white;
        }

        /* Colonne description */
        .description-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.9em;
            color: #666;
        }

        /* Badges de progression */
        .status-1 {
            background-color: #3498db;
            color: white;
        }

        .status-2, .status-3 {
            background-color: #f39c12;
            color: white;
        }

        .status-4 {
            background-color: #e74c3c;
            color: white;
        }

        .status-5 {
            background-color: #9b59b6;
            color: white;
        }

        .status-6 {
            background-color: #27ae60;
            color: white;
        }

        .status-7 {
            background-color: #95a5a6;
            color: white;
        }

        /* Boutons d'actions */
        .status-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
        }

        .status-btn {
            padding: 6px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: white;
            color: #666;
        }

        .status-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .status-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Boutons de statut actifs */
        .status-btn.active-1 {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .status-btn.active-2,
        .status-btn.active-3 {
            background-color: #f39c12;
            color: white;
            border-color: #f39c12;
        }

        .status-btn.active-4 {
            background-color: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        .status-btn.active-5 {
            background-color: #9b59b6;
            color: white;
            border-color: #9b59b6;
        }

        .status-btn.active-6 {
            background-color: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        .status-btn.active-7 {
            background-color: #95a5a6;
            color: white;
            border-color: #95a5a6;
        }

        .no-tasks {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .no-tasks-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .no-tasks h2 {
            font-family: 'Playfair Display', serif;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .no-tasks p {
            margin-bottom: 20px;
        }

        /* Responsive Design - Progressive du plus grand au plus petit */
        
        /* Tr√®s grand √©cran - au-dessus de 2000px : marges automatiques */
        @media (min-width: 2001px) {
            body {
                padding: 20px calc((100% - 2000px) / 2);
            }
        }
        
        /* Grand √©cran - 1400px √† 2000px */
        @media (max-width: 1400px) {
            .container {
                padding: 35px;
            }
        }
        
        /* √âcran moyen - 1024px √† 1400px */
        @media (max-width: 1024px) {
            .container {
                padding: 30px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            table {
                font-size: 0.9em;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .badge {
                font-size: 0.8em;
                padding: 3px 10px;
            }
            
            .status-btn {
                padding: 5px 10px;
                font-size: 0.75em;
            }
        }
        
        /* Tablette - 768px √† 1024px */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .container {
                padding: 25px;
                border-radius: 8px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .header-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-buttons {
                justify-content: center;
            }
            
            table {
                font-size: 0.85em;
            }
            
            th, td {
                padding: 8px 5px;
                font-size: 0.9em;
            }
            
            .description-cell {
                max-width: 200px;
            }
            
            .badge {
                font-size: 0.75em;
                padding: 3px 8px;
            }
            
            .status-btn {
                padding: 4px 8px;
                font-size: 0.7em;
            }
        }
        
        /* Mobile - 480px √† 768px */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px 15px;
                border-radius: 6px;
            }
            
            h1 {
                font-size: 1.5em;
                margin-bottom: 20px;
            }
            
            .filter-btn {
                font-size: 0.85em;
                padding: 6px 10px;
            }
            
            table {
                font-size: 0.8em;
            }
            
            th, td {
                padding: 6px 4px;
                font-size: 0.85em;
                word-wrap: break-word;
            }
            
            .description-cell {
                max-width: 120px;
            }
            
            .badge {
                font-size: 0.7em;
                padding: 2px 6px;
            }
            
            .status-buttons {
                gap: 2px;
            }
            
            .status-btn {
                padding: 3px 6px;
                font-size: 0.65em;
            }
        }
        
        /* Petit mobile - 320px √† 480px */
        @media (max-width: 375px) {
            body {
                padding: 8px;
            }
            
            .container {
                padding: 15px 10px;
            }
            
            h1 {
                font-size: 1.3em;
            }
            
            .filter-btn {
                font-size: 0.8em;
                padding: 5px 8px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 0.9em;
            }
            
            table {
                font-size: 0.75em;
            }
            
            th, td {
                padding: 5px 3px;
                font-size: 0.8em;
            }
            
            .description-cell {
                max-width: 80px;
            }
            
            .badge {
                font-size: 0.65em;
                padding: 2px 5px;
            }
            
            .status-btn {
                padding: 2px 4px;
                font-size: 0.6em;
            }
        }
        
        /* Tr√®s petit mobile - 320px minimum */
        @media (max-width: 320px) {
            .container {
                padding: 12px 8px;
            }
            
            h1 {
                font-size: 1.2em;
            }
            
            table {
                font-size: 0.7em;
            }
            
            th, td {
                padding: 4px 2px;
            }
            
            .description-cell {
                max-width: 60px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }
            
            .header-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-buttons {
                justify-content: center;
                margin: 10px 0;
            }
            
            .btn {
                width: 100%;
                text-align: center;
            }

            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            th, td {
                font-size: 0.85em;
            }
            
            .status-buttons {
                gap: 3px;
            }
            
            .status-btn {
                padding: 4px 8px;
                font-size: 0.65em;
            }
            
            /* R√©duire la largeur des colonnes pour √©viter le d√©bordement */
            th, td {
                padding: 8px 5px;
                font-size: 0.8em;
                word-wrap: break-word;
            }
            
            .description-cell {
                max-width: 150px;
            }
            
            .badge {
                font-size: 0.7em;
                padding: 3px 8px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .filter-btn {
                font-size: 0.85em;
                padding: 6px 12px;
            }
            
            .task-count {
                font-size: 0.95em;
            }
            
            table {
                font-size: 0.8em;
            }
            
            /* R√©duire encore plus pour petit mobile */
            th, td {
                padding: 6px 3px;
                font-size: 0.75em;
            }
            
            .description-cell {
                max-width: 100px;
            }
            
            .badge {
                font-size: 0.65em;
                padding: 2px 6px;
            }
            
            .status-btn {
                padding: 3px 6px;
                font-size: 0.6em;
                min-width: 24px;
            }
        }

        /* Lien de retour √† l'index */
        .back-link {
            display: inline-block;
            margin-bottom: 15px;
            color: #4a7c59;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .back-link:hover {
            color: #2d5016;
            text-decoration: underline;
        }
    </style>

    <script>
        // A) Variables globales pour les donn√©es de r√©f√©rence
        // Port√©e globale : ces variables sont accessibles depuis n'importe quelle fonction
        let priorityList = [];
        let taskProgressionList = [];
        let academicSubjectsList = [];
        let skillsLevelList = [];
        let difficultyRatingList = [];
        let currentFilter = 'all'; // Filtre actuel : 'all', '6' (termin√©es), '7' (archiv√©es)
        
        // B) Lecture des t√¢ches depuis localStorage
        let tasksList = [];
        
        console.log("üöÄ Chargement de la page de r√©capitulatif des t√¢ches");
        
        // Lecture du localStorage
        let storedTasks = localStorage.getItem("tasksData");
        
        if (storedTasks) {
            console.log("‚úÖ Des t√¢ches ont √©t√© trouv√©es dans le localStorage");
            tasksList = JSON.parse(storedTasks);
            console.log("üìä Nombre de t√¢ches r√©cup√©r√©es :", tasksList.length);
            console.log("üìã Liste des t√¢ches :", tasksList);
        } else {
            console.log("‚ÑπÔ∏è Aucune t√¢che trouv√©e dans le localStorage");
        }
        
        // C) Attendre que le document soit enti√®rement charg√©
        document.onreadystatechange = function() {
            console.log("üìÑ √âtat du document :", document.readyState);
            
            if (document.readyState === "complete") {
                console.log("‚úÖ Document enti√®rement charg√©");
                
                // Charger les donn√©es de r√©f√©rence (priorit√©s, statuts, etc.)
                loadReferenceData();
            }
        };
        
        /**
         * Charge les donn√©es de r√©f√©rence (int√©gr√©es directement dans le code)
         * Utilisation uniquement du localStorage - pas de fetch()
         */
        function loadReferenceData() {
            console.log("üì• Chargement des donn√©es de r√©f√©rence...");
            
            // Donn√©es de priorit√© (int√©gr√©es directement)
            priorityList = [
                { "idPriorite": "1", "priorite": "Important" },
                { "idPriorite": "2", "priorite": "Haut" },
                { "idPriorite": "3", "priorite": "Moyen" },
                { "idPriorite": "4", "priorite": "Bas" },
                { "idPriorite": "5", "priorite": "Non important" }
            ];
            console.log("‚úÖ Priorit√©s charg√©es :", priorityList);
            
            // Donn√©es de progression (int√©gr√©es directement)
            taskProgressionList = [
                { "idTaskProgression": "1", "taskProgressionStatus": "Nouvelle t√¢che" },
                { "idTaskProgression": "2", "taskProgressionStatus": "conception" },
                { "idTaskProgression": "3", "taskProgressionStatus": "en cours" },
                { "idTaskProgression": "4", "taskProgressionStatus": "bloqu√©" },
                { "idTaskProgression": "5", "taskProgressionStatus": "en attente de validation" },
                { "idTaskProgression": "6", "taskProgressionStatus": "Termin√©" },
                { "idTaskProgression": "7", "taskProgressionStatus": "Archiv√©" }
            ];
            console.log("‚úÖ Statuts de progression charg√©s :", taskProgressionList);
            
            // Sujets acad√©miques (int√©gr√©s directement)
            academicSubjectsList = [
                { "idAcademicSubject": "1", "academicSubjectName": "HTML/CSS" },
                { "idAcademicSubject": "2", "academicSubjectName": "JavaScript" },
                { "idAcademicSubject": "3", "academicSubjectName": "Frameworks JavaScript (React, Vue.js)" },
                { "idAcademicSubject": "4", "academicSubjectName": "D√©veloppement Backend (Node.js, PHP)" },
                { "idAcademicSubject": "5", "academicSubjectName": "Bases de donn√©es (SQL, NoSQL)" },
                { "idAcademicSubject": "6", "academicSubjectName": "UX/UI Design" },
                { "idAcademicSubject": "7", "academicSubjectName": "Responsive Design et Mobile First" },
                { "idAcademicSubject": "8", "academicSubjectName": "Gestion de projet web (Agile, Scrum)" },
                { "idAcademicSubject": "9", "academicSubjectName": "Versioning (Git, GitHub)" },
                { "idAcademicSubject": "10", "academicSubjectName": "Accessibilit√© web (WCAG)" },
                { "idAcademicSubject": "11", "academicSubjectName": "SEO et R√©f√©rencement" },
                { "idAcademicSubject": "12", "academicSubjectName": "APIs et Services Web (REST, GraphQL)" }
            ];
            console.log("‚úÖ Sujets acad√©miques charg√©s :", academicSubjectsList);
            
            // Niveaux de comp√©tence (int√©gr√©s directement)
            skillsLevelList = [
                { "idSkillsLevel": "1", "skillsLevel": "D√©butant" },
                { "idSkillsLevel": "2", "skillsLevel": "Interm√©diaire" },
                { "idSkillsLevel": "3", "skillsLevel": "Avanc√©" },
                { "idSkillsLevel": "4", "skillsLevel": "Expert" }
            ];
            console.log("‚úÖ Niveaux de comp√©tence charg√©s :", skillsLevelList);
            
            // Niveaux de difficult√© (int√©gr√©s directement)
            difficultyRatingList = [
                { "idDifficultyRating": "1", "difficultyRating": "Tr√®s facile" },
                { "idDifficultyRating": "2", "difficultyRating": "Facile" },
                { "idDifficultyRating": "3", "difficultyRating": "Moyen" },
                { "idDifficultyRating": "4", "difficultyRating": "Difficile" },
                { "idDifficultyRating": "5", "difficultyRating": "Tr√®s difficile" }
            ];
            console.log("‚úÖ Niveaux de difficult√© charg√©s :", difficultyRatingList);
            
            // Maintenant que tout est charg√©, g√©n√©rer le tableau
            generateTasksTable();
        }
        
        /**
         * D) G√©n√®re et ins√®re le tableau HTML des t√¢ches
         * @param {string} filter - Filtre √† appliquer : 'all', '6', '7'
         */
        function generateTasksTable(filter = 'all') {
            console.log(`üèóÔ∏è G√©n√©ration du tableau HTML des t√¢ches (filtre: ${filter})`);
            
            const tbody = document.getElementById('tasksTableBody');
            const taskCount = document.getElementById('taskCount');
            
            // Filtrer les t√¢ches selon le filtre s√©lectionn√©
            let filteredTasks;
            if (filter === 'all') {
                // Toutes les t√¢ches sauf les archiv√©es
                filteredTasks = tasksList.filter(task => task.idTaskProgression != "7");
            } else if (filter === '6') {
                // Seulement les t√¢ches termin√©es
                filteredTasks = tasksList.filter(task => task.idTaskProgression == "6");
            } else if (filter === '7') {
                // Seulement les t√¢ches archiv√©es
                filteredTasks = tasksList.filter(task => task.idTaskProgression == "7");
            } else {
                filteredTasks = tasksList;
            }
            
            // Afficher le nombre de t√¢ches
            const filterLabel = filter === 'all' ? 'active(s)' : 
                               filter === '6' ? 'termin√©e(s)' : 
                               filter === '7' ? 'archiv√©e(s)' : '';
            taskCount.textContent = `${filteredTasks.length} t√¢che(s) ${filterLabel} / ${tasksList.length} total`;
            
            // Vider le tbody avant de le remplir
            tbody.innerHTML = '';
            
            // Si aucune t√¢che, afficher un message
            if (filteredTasks.length === 0) {
                const message = filter === 'all' ? 'Aucune t√¢che active' :
                               filter === '6' ? 'Aucune t√¢che termin√©e' :
                               filter === '7' ? 'Aucune t√¢che archiv√©e' : 'Aucune t√¢che';
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-tasks">
                            <div class="no-tasks-icon">üìã</div>
                            <h2>${message}</h2>
                            <p>${filter === 'all' ? 'Commencez par cr√©er votre premi√®re t√¢che !' : 'Changez de filtre pour voir d\'autres t√¢ches.'}</p>
                            ${filter === 'all' ? '<a href="Form-ToDoList.html" class="btn">Cr√©er une t√¢che</a>' : ''}
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Variable pour construire le HTML
            let htmlContent = '';
            
            // Parcourir toutes les t√¢ches filtr√©es avec forEach()
            filteredTasks.forEach((task, index) => {
                console.log(`üìå Traitement de la t√¢che ${index + 1} :`, task);
                
                // Rechercher la priorit√© correspondante avec find()
                // La fonction fl√©ch√©e compare l'idPriorite de chaque √©l√©ment avec celui de la t√¢che
                const priorityObj = priorityList.find(
                    element => element.idPriorite == task.idPriorite
                );
                const priorityLabel = priorityObj ? priorityObj.priorite : 'Non d√©fini';
                console.log(`  üîç Priorit√© trouv√©e : ${priorityLabel}`);
                
                // Rechercher le statut de progression
                const progressObj = taskProgressionList.find(
                    element => element.idTaskProgression == task.idTaskProgression
                );
                const progressLabel = progressObj ? progressObj.taskProgressionStatus : 'Non d√©fini';
                console.log(`  üîç Statut trouv√© : ${progressLabel}`);
                
                // Rechercher le sujet acad√©mique
                const subjectObj = academicSubjectsList.find(
                    element => element.idAcademicSubject == task.idAcademicSubject
                );
                const subjectLabel = subjectObj ? subjectObj.academicSubjectName : 'Non d√©fini';
                console.log(`  üîç Sujet trouv√© : ${subjectLabel}`);
                
                // Formater la date de cr√©ation (format jj/mm/aaaa uniquement)
                const dateCreation = new Date(task.date_de_creation);
                const dateFormatted = dateCreation.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                // Fonction pour obtenir l'ic√¥ne correspondant au statut
                const getStatusIcon = (statusId) => {
                    const icons = {
                        '1': 'üìù', // Nouvelle t√¢che
                        '2': '‚è∏Ô∏è', // En attente
                        '3': '‚ñ∂Ô∏è', // En cours
                        '4': 'üö´', // Bloqu√©
                        '5': '‚úîÔ∏è', // Valid√©
                        '6': '‚úÖ', // Termin√©
                        '7': 'üì¶'  // Archiv√©
                    };
                    return icons[statusId] || '‚ùì';
                };
                
                // G√©n√©rer les boutons de statut
                let statusButtons = '';
                taskProgressionList.forEach(status => {
                    const isActive = status.idTaskProgression == task.idTaskProgression;
                    const activeClass = isActive ? `active-${status.idTaskProgression}` : '';
                    const disabled = isActive ? 'disabled' : '';
                    
                    statusButtons += `
                        <button 
                            class="status-btn ${activeClass}" 
                            data-task-id="${task.id}" 
                            data-status-id="${status.idTaskProgression}"
                            onclick="updateTaskStatus(${task.id}, '${status.idTaskProgression}')"
                            ${disabled}
                            title="${status.taskProgressionStatus}">
                            ${getStatusIcon(status.idTaskProgression)}
                        </button>
                    `;
                });
                
                // Trouver le niveau de comp√©tence et la difficult√©
                let skillsLevel = skillsLevelList.find(s => s.idSkillsLevel == task.idSkillsLevel);
                let skillsLabel = skillsLevel ? skillsLevel.skillsLevel : 'N/A';
                
                let difficulty = difficultyRatingList.find(d => d.idDifficultyRating == task.idDifficultyRating);
                let difficultyLabel = difficulty ? difficulty.difficultyRating : 'N/A';
                
                // Construire la ligne HTML avec template literals (backticks)
                // L'interpolation ${...} permet d'ins√©rer des variables dynamiquement
                htmlContent += `
                    <tr data-task-id="${task.id}">
                        <td><strong>${task.libelle}</strong></td>
                        <td class="description-cell">${task.description || 'Aucune description'}</td>
                        <td>${task.assignation}</td>
                        <td>${subjectLabel}</td>
                        <td>
                            <span class="badge skills-${task.idSkillsLevel}">
                                ${skillsLabel}
                            </span>
                        </td>
                        <td>
                            <span class="badge difficulty-${task.idDifficultyRating}">
                                ${difficultyLabel}
                            </span>
                        </td>
                        <td>
                            <span class="badge priority-${task.idPriorite}">
                                ${priorityLabel}
                            </span>
                        </td>
                        <td>
                            <span class="badge status-${task.idTaskProgression}">
                                ${progressLabel}
                            </span>
                        </td>
                        <td>${task["compteur_de_temps_passe(mn)"] || 0} min</td>
                        <td>${dateFormatted}</td>
                        <td>
                            <div class="status-buttons">
                                ${statusButtons}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            console.log("‚úÖ HTML g√©n√©r√© avec succ√®s");
            
            // Ins√©rer le HTML dans le tbody
            // insertAdjacentHTML avec "beforeend" ajoute le contenu √† la fin de l'√©l√©ment
            tbody.insertAdjacentHTML("beforeend", htmlContent);
            
            console.log("‚úÖ Tableau ins√©r√© dans le DOM");
            
            // G√©n√©rer le tableau des sous-t√¢ches
            generateSubtasksTable(filteredTasks);
        }
        
        /**
         * G√©n√®re et ins√®re le tableau des sous-t√¢ches
         * @param {Array} tasks - Liste des t√¢ches filtr√©es
         */
        function generateSubtasksTable(tasks) {
            console.log("üèóÔ∏è G√©n√©ration du tableau des sous-t√¢ches");
            
            const subtasksTbody = document.getElementById('subtasksTableBody');
            subtasksTbody.innerHTML = '';
            
            // Lire les sous-t√¢ches depuis le localStorage s√©par√©
            let allSubtasks = [];
            const storedSubtasks = localStorage.getItem("subtasksData");
            if (storedSubtasks) {
                allSubtasks = JSON.parse(storedSubtasks);
                console.log("üì¶ Sous-t√¢ches charg√©es depuis localStorage :", allSubtasks);
            }
            
            let subtasksHtml = '';
            let subtasksCount = 0;
            
            // Filtrer les sous-t√¢ches pour n'afficher que celles des t√¢ches filtr√©es
            const taskIds = tasks.map(t => t.id);
            const filteredSubtasks = allSubtasks.filter(st => taskIds.includes(st.taskId));
            
            filteredSubtasks.forEach(subtask => {
                subtasksCount++;
                
                // Trouver la t√¢che principale
                const parentTask = tasks.find(t => t.id === subtask.taskId);
                const taskLibelle = parentTask ? parentTask.libelle : 'T√¢che inconnue';
                
                subtasksHtml += `
                    <tr>
                        <td><strong>${taskLibelle}</strong></td>
                        <td>${subtask.subTaskLibelle}</td>
                        <td class="description-cell">${subtask.subTaskDescription || 'Aucune description'}</td>
                    </tr>
                `;
            });
            
            if (subtasksCount === 0) {
                subtasksHtml = `
                    <tr>
                        <td colspan="3" class="no-tasks">
                            <div class="no-tasks-icon">üìù</div>
                            <p>Aucune sous-t√¢che enregistr√©e</p>
                        </td>
                    </tr>
                `;
            }
            
            subtasksTbody.insertAdjacentHTML("beforeend", subtasksHtml);
            console.log(`‚úÖ ${subtasksCount} sous-t√¢che(s) affich√©e(s)`);
        }
        
        /**
         * √âtape 3D : Mise √† jour du statut d'une t√¢che
         * @param {number} taskId - L'ID de la t√¢che √† mettre √† jour
         * @param {string} newStatusId - Le nouvel ID de statut
         */
        function updateTaskStatus(taskId, newStatusId) {
            console.log(`üîÑ Mise √† jour du statut de la t√¢che ${taskId} vers ${newStatusId}`);
            
            // C) Gestion du changement de statut
            
            // 1. Lire la liste des t√¢ches depuis le localStorage
            let storedTasks = localStorage.getItem("tasksData");
            if (!storedTasks) {
                console.error("‚ùå Aucune t√¢che trouv√©e dans le localStorage");
                return;
            }
            
            tasksList = JSON.parse(storedTasks);
            console.log("üì• T√¢ches recharg√©es depuis localStorage");
            
            // 2. Identifier la t√¢che √† partir de son ID avec find()
            const taskToUpdate = tasksList.find(task => task.id == taskId);
            
            if (!taskToUpdate) {
                console.error(`‚ùå T√¢che ${taskId} non trouv√©e`);
                return;
            }
            
            console.log("üìå T√¢che trouv√©e :", taskToUpdate);
            
            // 3. Mettre √† jour la propri√©t√© statut
            const oldStatus = taskToUpdate.idTaskProgression;
            taskToUpdate.idTaskProgression = newStatusId;
            
            // Mettre √† jour aussi la date de modification
            taskToUpdate.date_de_modification = new Date().toISOString();
            
            // Si le statut passe √† "Termin√©" (6), mettre la date de completion
            if (newStatusId == "6") {
                taskToUpdate.date_de_completion = new Date().toISOString();
                console.log("‚úÖ T√¢che marqu√©e comme termin√©e");
            }
            
            console.log(`‚úèÔ∏è Statut chang√© de ${oldStatus} √† ${newStatusId}`);
            
            // 4. Enregistrer la liste mise √† jour dans le localStorage
            localStorage.setItem("tasksData", JSON.stringify(tasksList));
            console.log("üíæ T√¢ches sauvegard√©es dans localStorage");
            
            // 5. Mettre √† jour l'affichage
            // Si le statut est "Archiv√©" (7), r√©g√©n√©rer tout le tableau
            if (newStatusId == "7") {
                console.log("üì¶ T√¢che archiv√©e - R√©g√©n√©ration du tableau");
                generateTasksTable(currentFilter);
                alert(`‚úÖ T√¢che #${taskId} archiv√©e avec succ√®s !`);
            } else {
                // Sinon, mettre √† jour seulement la ligne concern√©e
                updateTaskRow(taskId);
                
                const statusObj = taskProgressionList.find(s => s.idTaskProgression == newStatusId);
                const statusLabel = statusObj ? statusObj.taskProgressionStatus : newStatusId;
                alert(`‚úÖ Statut de la t√¢che #${taskId} chang√© vers "${statusLabel}"`);
            }
        }
        
        /**
         * Met √† jour uniquement la ligne d'une t√¢che sp√©cifique
         * @param {number} taskId - L'ID de la t√¢che √† mettre √† jour
         */
        function updateTaskRow(taskId) {
            console.log(`üîÑ Mise √† jour de la ligne de la t√¢che ${taskId}`);
            
            // Trouver la t√¢che
            const task = tasksList.find(t => t.id == taskId);
            if (!task) return;
            
            // Trouver la ligne dans le tableau
            const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
            if (!row) return;
            
            // Mettre √† jour le badge de statut
            const statusObj = taskProgressionList.find(s => s.idTaskProgression == task.idTaskProgression);
            const statusLabel = statusObj ? statusObj.taskProgressionStatus : 'Non d√©fini';
            
            const statusCell = row.cells[5]; // Colonne "Statut"
            statusCell.innerHTML = `
                <span class="badge status-${task.idTaskProgression}">
                    ${statusLabel}
                </span>
            `;
            
            // Mettre √† jour les boutons d'action
            const actionsCell = row.cells[7]; // Colonne "Actions"
            let statusButtons = '';
            
            taskProgressionList.forEach(status => {
                const isActive = status.idTaskProgression == task.idTaskProgression;
                const activeClass = isActive ? `active-${status.idTaskProgression}` : '';
                const disabled = isActive ? 'disabled' : '';
                
                statusButtons += `
                    <button 
                        class="status-btn ${activeClass}" 
                        data-task-id="${task.id}" 
                        data-status-id="${status.idTaskProgression}"
                        onclick="updateTaskStatus(${task.id}, '${status.idTaskProgression}')"
                        ${disabled}
                        title="${status.taskProgressionStatus}">
                        ${status.idTaskProgression}
                    </button>
                `;
            });
            
            actionsCell.innerHTML = `<div class="status-buttons">${statusButtons}</div>`;
            
            console.log("‚úÖ Ligne mise √† jour");
        }
        
        /**
         * D) Bonus : Fonction de filtrage des t√¢ches
         * @param {string} filter - Type de filtre : 'all', '6' (termin√©es), '7' (archiv√©es)
         */
        function filterTasks(filter) {
            console.log(`üîç Application du filtre : ${filter}`);
            
            // Mettre √† jour le filtre actuel
            currentFilter = filter;
            
            // Mettre √† jour l'apparence des boutons de filtre
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activer le bouton correspondant
            event.target.classList.add('active');
            
            // R√©g√©n√©rer le tableau avec le filtre
            generateTasksTable(filter);
        }
    </script>
</head>
<body>
    <main class="container">
        <header>
            <a href="../index.html" class="back-link">‚Üê Retour √† l'index</a>
                <h1>üìã R√©capitulatif des T√¢ches</h1>
        
                <nav class="header-actions">
                    <div class="task-count" id="taskCount">0 t√¢che(s) enregistr√©e(s)</div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterTasks('all')">Toutes</button>
                        <button class="filter-btn" onclick="filterTasks('6')">Termin√©es</button>
                        <button class="filter-btn" onclick="filterTasks('7')">Archiv√©es</button>
                    </div>
                    <a href="Form-ToDoList.html" class="btn">+ Nouvelle t√¢che</a>
                </nav>
        </header>
        
        <article>
            <!-- A) Structure de base du tableau HTML -->
            <table>
                <thead>
                    <tr>
                        <th>Titre</th>
                        <th>Description</th>
                        <th>Assign√© √†</th>
                        <th>Sujet</th>
                        <th>Niveau</th>
                        <th>Difficult√©</th>
                        <th>Priorit√©</th>
                        <th>Statut</th>
                        <th>Temps (min)</th>
                        <th>Date cr√©ation</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <!-- Le contenu sera ins√©r√© ici dynamiquement -->
                <tbody id="tasksTableBody">
                    <!-- Les lignes seront g√©n√©r√©es par JavaScript -->
                </tbody>
            </table>
            <aside style="margin-top: 40px;">
                <h2 style="font-family: 'Playfair Display', serif; color: #2d5016; margin-bottom: 20px;">üìã Sous-t√¢ches</h2>
                <table>
                    <thead>
                        <tr>
                            <th>T√¢che principale</th>
                            <th>Sous-t√¢che</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody id="subtasksTableBody">
                        <!-- Les sous-t√¢ches seront g√©n√©r√©es par JavaScript -->
                    </tbody>
                </table>
            </aside>        
        </article>
        
        
    </main>
</body>
</html>
